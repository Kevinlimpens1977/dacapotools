import{u as O,r as c,t as U,j as e,w as K,q as P,p as R,n as C,m as F,o as _,x as q,y as H,z as V,A as Q}from"./index-CywKMS_j.js";import{g as Y,A as k}from"./appCredits-BgLXLukM.js";function I(){const{isSupervisor:x}=O(),[d,b]=c.useState({}),[h,p]=c.useState({}),[j,N]=c.useState({userCosts:[],appCosts:{}}),[v,o]=c.useState({}),[u,y]=c.useState(!0),[w,z]=c.useState({}),[L,D]=c.useState(!0),[M,S]=c.useState(!1),g=Y(),G=U(K,"getCostsSummary"),i=c.useMemo(()=>{const s=new Date,t=s.getFullYear(),a=String(s.getMonth()+1).padStart(2,"0");return`${t}-${a}`},[]);c.useEffect(()=>{(async()=>{y(!0);const t={},a=g.map(async r=>{try{const n=await G({appId:r});t[r]={used:n.data?.totalUsage??0,cost:n.data?.totalCost??0,monthKey:n.data?.monthKey??i}}catch(n){console.error(`Failed to fetch costs for ${r}:`,n),t[r]={used:0,cost:0,monthKey:i}}});await Promise.all(a),o(t),y(!1)})()},[i]),c.useEffect(()=>{(async()=>{try{const t=await P(R(C,"users")),a={};t.forEach(r=>{a[r.id]=r.data()}),z(a)}catch(t){console.error("Error fetching users:",t)}})()},[]),c.useEffect(()=>{(async()=>{try{const t=F(C,"admin","costConfig"),a=await _(t);a.exists()?b(a.data()):b({paco:.05,translate:.001})}catch(t){console.error("Error fetching prices:",t)}})()},[]),c.useEffect(()=>{i&&(async()=>{D(!0);try{const t=q(H(C,"costs"),V("monthKey","==",i)),a=await P(t),r={},n={};a.forEach(m=>{const l=m.data(),E=m.ref.path.split("/"),A=E[1];if(E.length===4)n[A]={cost:l.totalCost||0,used:l.totalUsage||0,count:l.count||0};else if(E.length===6){const f=l.uid;r[f]||(r[f]={uid:f,totalCost:0,apps:{}}),r[f].apps[A]={cost:l.totalCost||0,totalUsedThisMonth:l.totalUsage||0},r[f].totalCost+=l.totalCost||0}}),N({userCosts:Object.values(r).sort((m,l)=>l.totalCost-m.totalCost),appCosts:n})}catch(t){console.error("Error fetching cost aggregates:",t)}finally{D(!1)}})()},[i]);const B=(s,t)=>{p(a=>({...a,[s]:t}))},T=async s=>{if(!x)return;const t=h[s];if(t===void 0)return;const a=parseFloat(t);if(isNaN(a)||a<0){p(r=>{const n={...r};return delete n[s],n});return}try{S(!0);const r=F(C,"admin","costConfig");await Q(r,{[s]:a},{merge:!0}),b(n=>({...n,[s]:a})),p(n=>{const m={...n};return delete m[s],m})}catch(r){console.error("Error saving price:",r),alert("Fout bij opslaan prijs")}finally{S(!1)}},$=Object.values(v).reduce((s,t)=>s+(t.cost||0),0);return L?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx("span",{className:"material-symbols-outlined text-4xl animate-spin text-[#2860E0]",children:"sync"}),e.jsx("p",{className:"text-secondary mt-2 text-sm",children:"Rapport genereren..."})]})}):e.jsxs("div",{className:"space-y-6 max-w-7xl",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Kosten"}),e.jsxs("p",{className:"text-secondary mt-1",children:["Overzicht van platformkosten per app en gebruiker (",i,")"]}),e.jsxs("div",{className:"text-xs text-amber-600 bg-amber-50 dark:bg-amber-900/20 px-2 py-1 rounded inline-block mt-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm align-middle mr-1",children:"history"}),"Data wordt elk uur geüpdatet"]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-[#2860E0] to-[#1C4DAB] rounded-xl p-6 text-white",children:[e.jsx("p",{className:"text-white/70 text-sm",children:"Totale Kosten Deze Maand"}),e.jsxs("p",{className:"text-4xl font-bold mt-2",children:["€",$.toFixed(2)]}),e.jsx("p",{className:"text-white/70 text-sm mt-2",children:"Gebaseerd op server-side aggregatie"})]}),e.jsxs("div",{className:"bg-card rounded-xl border border-theme p-5",children:[e.jsx("h3",{className:"font-semibold mb-4",children:"Kosten per App"}),e.jsx("div",{className:"space-y-4",children:g.map(s=>{const t=k[s],a=v[s]||{used:0,cost:0},r=d[s]||0,n=u;return e.jsxs("div",{className:"flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"size-12 rounded-lg bg-[#2860E0]/10 flex items-center justify-center",children:e.jsx("span",{className:"material-symbols-outlined text-[#2860E0]",children:s==="paco"?"image":"translate"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:t.appName}),e.jsxs("p",{className:"text-sm text-secondary",children:[n?"…":a.used," ",t.creditUnitPlural," verbruikt"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xl font-bold",children:n?"…":`€${(a.cost||0).toFixed(2)}`}),e.jsxs("p",{className:"text-xs text-secondary",children:["Huidige prijs: €",r.toFixed(3)]})]})]},s)})})]}),e.jsxs("div",{className:"bg-card rounded-xl border border-theme p-5",children:[e.jsxs("h3",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-amber-500",children:"settings"}),"Prijsconfiguratie",!x&&e.jsx("span",{className:"text-xs font-normal text-secondary ml-2",children:"(alleen-lezen)"})]}),e.jsx("div",{className:"grid md:grid-cols-2 gap-4",children:g.map(s=>{const t=k[s],a=d[s]||0;return e.jsxs("div",{className:"p-4 border border-theme rounded-lg",children:[e.jsx("p",{className:"font-medium mb-2",children:t.appName}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-secondary",children:"€"}),e.jsx("input",{type:"number",step:"0.001",value:h[s]!==void 0?h[s]:a,onChange:r=>B(s,r.target.value),onBlur:()=>T(s),className:"flex-1 px-3 py-2 rounded-lg border border-theme bg-white dark:bg-gray-800 disabled:opacity-60 disabled:cursor-not-allowed",disabled:!x||M}),e.jsxs("span",{className:"text-sm text-secondary",children:["per ",t.creditUnit]})]})]},s)})})]}),e.jsxs("div",{className:"bg-card rounded-xl border border-theme overflow-x-auto",children:[e.jsx("div",{className:"p-4 border-b border-theme",children:e.jsx("h3",{className:"font-semibold",children:"Kosten per Gebruiker (Toplijst)"})}),e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-800/50 border-b border-theme",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-4 py-3 font-semibold",children:"Gebruiker"}),g.map(s=>e.jsx("th",{className:"text-center px-4 py-3 font-semibold",children:k[s]?.appName},s)),e.jsx("th",{className:"text-right px-4 py-3 font-semibold",children:"Totaal"})]})}),e.jsx("tbody",{children:j.userCosts.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:g.length+2,className:"px-4 py-8 text-center text-secondary",children:"Nog geen kosten geregistreerd deze maand."})}):j.userCosts.slice(0,50).map(s=>{const t=w[s.uid]||{};return e.jsxs("tr",{className:"border-b border-theme last:border-0 hover:bg-gray-50 dark:hover:bg-gray-800/30",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:t.displayName||"Onbekend"}),e.jsx("p",{className:"text-sm text-secondary",children:t.email||"Geen email"})]})}),g.map(a=>{const n=s.apps[a]?.cost||0;return e.jsx("td",{className:"px-4 py-3 text-center text-secondary",children:n>0?`€${n.toFixed(2)}`:"-"},a)}),e.jsxs("td",{className:"px-4 py-3 text-right font-medium",children:["€",s.totalCost.toFixed(2)]})]},s.uid)})})]})]}),e.jsxs("div",{className:"bg-card rounded-xl border border-theme p-5",children:[e.jsx("h3",{className:"font-semibold mb-4",children:"Maandelijkse Trend"}),e.jsx("div",{className:"h-48 flex items-center justify-center bg-gray-100 dark:bg-gray-800 rounded-lg",children:e.jsxs("div",{className:"text-center text-secondary",children:[e.jsx("span",{className:"material-symbols-outlined text-4xl mb-2 block",children:"show_chart"}),e.jsx("p",{className:"text-sm",children:"Historische data wordt nu verzameld."})]})})]}),e.jsx(J,{currentMonthKey:i})]})}function J({currentMonthKey:x}){const[d,b]=c.useState(null),[h,p]=c.useState(!1),[j,N]=c.useState(null),v=async()=>{p(!0),N(null);try{const u=await U(K,"getUserCostBreakdown")({monthKey:x});b(u.data)}catch(o){console.error("Error loading breakdown:",o),N(o.message)}finally{p(!1)}};return e.jsx("div",{className:"bg-card rounded-xl border border-theme p-5",children:e.jsxs("details",{className:"group",children:[e.jsxs("summary",{className:"font-bold cursor-pointer list-none flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-[#2860E0]",children:"table_view"}),"Kosten per gebruiker (Detailoverzicht)"]}),e.jsx("span",{className:"material-symbols-outlined transition-transform group-open:rotate-180",children:"expand_more"})]}),e.jsxs("div",{className:"mt-4 border-t border-theme pt-4",children:[e.jsxs("p",{className:"text-sm text-secondary mb-4",children:["Dit overzicht toont gedetailleerd gebruik en kosten per app voor de maand ",e.jsx("strong",{children:x}),". Data wordt opgehaald via een Cloud Function."]}),!d&&!h&&e.jsxs("button",{onClick:v,className:"px-4 py-2 bg-[#2860E0] text-white rounded-lg hover:bg-[#1C4DAB] transition-colors flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-sm",children:"download"}),"Laad Details"]}),h&&e.jsxs("div",{className:"flex items-center gap-3 text-[#2860E0]",children:[e.jsx("span",{className:"material-symbols-outlined animate-spin",children:"sync"}),e.jsx("span",{children:"Data ophalen..."})]}),j&&e.jsxs("div",{className:"text-red-500 bg-red-50 p-3 rounded-lg text-sm",children:["Fout bij laden: ",j]}),d&&e.jsx("div",{className:"overflow-x-auto mt-4",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-800/50 text-left border-b border-theme",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2",children:"Gebruiker"}),e.jsx("th",{className:"px-3 py-2",children:"Email"}),e.jsx("th",{className:"px-3 py-2",children:"App"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Verbruik"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Kosten"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100 dark:divide-gray-800",children:d.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"5",className:"px-3 py-4 text-center text-secondary",children:"Geen data gevonden voor deze maand."})}):d.sort((o,u)=>u.cost-o.cost).map((o,u)=>{const y=k[o.appId],w=y?y.appName:o.appId;return e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-800/30",children:[e.jsx("td",{className:"px-3 py-2 font-mono text-xs text-secondary",children:o.userId}),e.jsx("td",{className:"px-3 py-2 font-medium",children:o.userEmail}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("span",{className:"bg-blue-50 text-blue-700 px-2 py-0.5 rounded text-xs border border-blue-100 dark:bg-blue-900/30 dark:text-blue-300 dark:border-blue-900",children:w})}),e.jsx("td",{className:"px-3 py-2 text-right font-mono",children:o.usage}),e.jsxs("td",{className:"px-3 py-2 text-right font-medium",children:["€",o.cost.toFixed(4)]})]},`${o.userId}-${o.appId}`)})})]})})]})]})})}export{I as default};
